<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست تقویم شمسی</title>
    <style>
        body {
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .persian-datepicker {
            position: absolute;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 1000;
            margin-top: 8px;
            min-width: 320px;
        }
        
        .persian-datepicker .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .persian-datepicker .header button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .persian-datepicker .header button:hover {
            transform: scale(1.1);
        }
        
        .persian-datepicker .header span {
            font-size: 18px;
            color: #1e293b;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .weekday {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            padding: 8px;
            font-size: 14px;
        }
        
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .day:hover {
            background: #f1f5f9;
            transform: scale(1.05);
        }
        
        .day.other-month {
            opacity: 0;
            cursor: default;
        }
        
        .day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        .info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 14px;
            color: #475569;
        }
        
        .info strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗓️ تست تقویم شمسی</h1>
        
        <div class="form-group">
            <label>تاریخ شمسی (نمایش):</label>
            <div style="position: relative;">
                <input type="text" id="jalaliDateInput" placeholder="انتخاب تاریخ" readonly>
                <div id="persianDatepicker" class="persian-datepicker" style="display: none;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label>تاریخ میلادی (مخفی):</label>
            <input type="text" id="gregorianDateInput" readonly style="background: #f8fafc;">
        </div>
        
        <div class="info">
            <strong>امروز:</strong> <span id="todayInfo"></span>
        </div>
    </div>

    <script>
        // Persian calendar configuration
        const persianMonths = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
        const persianWeekdays = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];

        let currentJalaliYear, currentJalaliMonth;
        const today = new Date();
        const todayJalali = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
        currentJalaliYear = todayJalali[0];
        currentJalaliMonth = todayJalali[1];

        // Display today's info
        document.getElementById('todayInfo').textContent = 
            `${toPersianNumber(todayJalali[2])} ${persianMonths[todayJalali[1] - 1]} ${toPersianNumber(todayJalali[0])} (${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')})`;

        // Event listeners
        document.getElementById('jalaliDateInput').addEventListener('click', function(e) {
            e.stopPropagation();
            const datepicker = document.getElementById('persianDatepicker');
            datepicker.style.display = datepicker.style.display === 'none' ? 'block' : 'none';
            if (datepicker.style.display === 'block') {
                renderCalendar();
            }
        });

        document.addEventListener('click', function(e) {
            const datepicker = document.getElementById('persianDatepicker');
            const input = document.getElementById('jalaliDateInput');
            if (datepicker && !datepicker.contains(e.target) && e.target !== input) {
                datepicker.style.display = 'none';
            }
        });

        function renderCalendar() {
            const datepicker = document.getElementById('persianDatepicker');
            const daysInMonth = currentJalaliMonth <= 6 ? 31 : (currentJalaliMonth <= 11 ? 30 : (isJalaliLeapYear(currentJalaliYear) ? 30 : 29));
            const firstDayOfMonth = getJalaliDayOfWeek(currentJalaliYear, currentJalaliMonth, 1);
            
            let html = `
                <div class="header">
                    <button type="button" onclick="changeMonth(1); event.stopPropagation();">◀</button>
                    <span style="font-weight: 600;">${persianMonths[currentJalaliMonth - 1]} ${toPersianNumber(currentJalaliYear)}</span>
                    <button type="button" onclick="changeMonth(-1); event.stopPropagation();">▶</button>
                </div>
                <div class="weekdays">
                    ${persianWeekdays.map(day => `<div class="weekday">${day}</div>`).join('')}
                </div>
                <div class="days">
            `;
            
            // Empty cells before first day
            for (let i = 0; i < firstDayOfMonth; i++) {
                html += '<div class="day other-month"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === todayJalali[2] && currentJalaliMonth === todayJalali[1] && currentJalaliYear === todayJalali[0];
                const classes = ['day'];
                if (isToday) classes.push('today');
                
                html += `<div class="${classes.join(' ')}" onclick="selectDate(${day}); event.stopPropagation();">${toPersianNumber(day)}</div>`;
            }
            
            html += '</div>';
            datepicker.innerHTML = html;
        }

        function changeMonth(direction) {
            currentJalaliMonth += direction;
            if (currentJalaliMonth > 12) {
                currentJalaliMonth = 1;
                currentJalaliYear++;
            } else if (currentJalaliMonth < 1) {
                currentJalaliMonth = 12;
                currentJalaliYear--;
            }
            renderCalendar();
        }

        function selectDate(day) {
            const jalaliDate = `${currentJalaliYear}/${String(currentJalaliMonth).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
            const persianDate = toPersianNumber(jalaliDate);
            document.getElementById('jalaliDateInput').value = persianDate;
            
            const gregorianDate = jalaliToGregorian(currentJalaliYear, currentJalaliMonth, day);
            document.getElementById('gregorianDateInput').value = gregorianDate;
            document.getElementById('persianDatepicker').style.display = 'none';
        }

        function getJalaliDayOfWeek(jy, jm, jd) {
            const g = jalaliToGregorianArray(jy, jm, jd);
            const date = new Date(g[0], g[1] - 1, g[2]);
            return (date.getDay() + 1) % 7; // Adjust: Saturday = 0
        }

        function isJalaliLeapYear(year) {
            const breaks = [1, 5, 9, 13, 17, 22, 26, 30];
            const gy = year + 621;
            let jp = breaks[0];
            let jump = 0;
            
            for (let i = 1; i < breaks.length; i++) {
                const jm = breaks[i];
                jump = jm - jp;
                if (year < jm) break;
                jp = jm;
            }
            
            let n = year - jp;
            if (jump - n < 6) n = n - jump + (((jump + 4) - n) % 33);
            
            return ((n + 1) % 33) - 1 === 0 || (n % 33) - 1 === 0;
        }

        function toPersianNumber(num) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).replace(/\d/g, x => persianDigits[x]);
        }

        function gregorianToJalali(gy, gm, gd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            let days = (365 * gy) + (Math.floor((gy + 3) / 4)) - (Math.floor((gy + 99) / 100)) + (Math.floor((gy + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            if (gm > 2 && ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0))) days++;
            
            jy = jy + 33 * (Math.floor(days / 12053));
            days %= 12053;
            
            jy = jy + (4 * (Math.floor(days / 1461)));
            days %= 1461;
            
            if (days > 365) {
                jy = jy + Math.floor((days - 1) / 365);
                days = (days - 1) % 365;
            }
            
            const jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
            const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            
            return [jy, jm, jd];
        }

        function jalaliToGregorianArray(jy, jm, jd) {
            const g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            const j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            
            jy -= 979;
            jm -= 1;
            jd -= 1;
            
            let j_day_no = 365 * jy + Math.floor(jy / 33) * 8 + Math.floor((jy % 33 + 3) / 4);
            for (let i = 0; i < jm; ++i) j_day_no += j_days_in_month[i];
            j_day_no += jd;
            
            let g_day_no = j_day_no + 79;
            let gy = 1600 + 400 * Math.floor(g_day_no / 146097);
            g_day_no %= 146097;
            
            let leap = true;
            if (g_day_no >= 36525) {
                g_day_no--;
                gy += 100 * Math.floor(g_day_no / 36524);
                g_day_no %= 36524;
                if (g_day_no >= 365) g_day_no++;
                leap = false;
            }
            
            gy += 4 * Math.floor(g_day_no / 1461);
            g_day_no %= 1461;
            
            if (g_day_no >= 366) {
                leap = false;
                g_day_no--;
                gy += Math.floor(g_day_no / 365);
                g_day_no = g_day_no % 365;
            }
            
            let gm = 0;
            for (let i = 0; g_day_no >= g_days_in_month[i] + (i === 1 && leap ? 1 : 0); i++) {
                g_day_no -= g_days_in_month[i] + (i === 1 && leap ? 1 : 0);
                gm++;
            }
            const gd = g_day_no + 1;
            
            return [gy, gm + 1, gd];
        }

        function jalaliToGregorian(jy, jm, jd) {
            const g = jalaliToGregorianArray(jy, jm, jd);
            return `${g[0]}-${String(g[1]).padStart(2, '0')}-${String(g[2]).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
